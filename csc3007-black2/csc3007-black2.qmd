---
title: "CSC3007-Team-Black-2"
subtitle: "Add subtitle here"
author: "CHIA YI XUAN, TSUI SAU CHI, JEANIE OH JUN NING, VARADHARAJAN JAYAPRIYA, GU JINMING, WONG JUN HAO"
format:
  revealjs: 
    slide-number: true
    transition: fade
---

```{r}
#| label: required-packages
#| message: false

library(tidyverse)
library(countrycode)
library(directlabels)
library(ggrepel)
library(dplyr)
library(lintr)
library(readxl)
library(scales)
library(tmap)
library(GGally)
library(ggplot2)
library(plotly)
library(recipes)
library(priceR)
library(sf)
library(tidymodels)
library(rpart)
library(rpart.plot)
```

```{r}
#| echo: false

# Load & Clean the dataset / prepare it here.

# Load 5.1.1 data - Legal frameworks that promote enforce and monitor gender eqality (percentage of achievement 0 - 100) \-- Area 3: employment and economic benefits
indicator_5_1_1_employment_economic_benefits <- read_csv("data/Indicator_5.1.1%3A_Legal_frameworks_that_promote__enforce_and_monitor_gender_equality_(percentage_of_achievement__0_-_100)_--_Area_3%3A_employment_and_economic_benefits.csv", show_col_types = FALSE)

# Load 5.5.2 data - Proportion of women in managerial positions
indicator_5_5_2_managerial <- read_csv("data/Indicator_5.5.2%3A_Proportion_of_women_in_managerial_positions_(percent).csv", show_col_types = FALSE)

# Load 8.5.1 data - Average hourly earnings of employees by sex, age, occupation and persons with disabilities
indicator_8_5_1_average_hourly <- read_csv("data/Indicator_8.5.1%3A_Average_hourly_earnings_of_employees_by_sex_and_occupation_(local_currency).csv", show_col_types = FALSE)

# Load 8.5.2 data - Unemployment rate by sex, age and persons with disabilities
indicator_8_5_2_unemployment <- read_csv("data/Indicator_8.5.2%3A_Unemployment_rate__by_sex_and_disability_(percent).csv", show_col_types = FALSE)

# Load Map Geometry data from tmap
data(World)

# Clean data
indicator_5_1_1_employment_economic_benefits <- indicator_5_1_1_employment_economic_benefits |> select(indicator_reference, geoAreaName, parentName, type, X, Y, ISO3, latest_value)

indicator_5_5_2_managerial <- indicator_5_5_2_managerial |> select(indicator_reference, geoAreaName, parentName, type, X, Y, ISO3, latest_value)

indicator_8_5_1_average_hourly <- indicator_8_5_1_average_hourly |> select(indicator_reference, geoAreaName, parentName, type, X, Y, ISO3, sex_code, sex_desc, type_of_occupation_desc, latest_value)

indicator_8_5_2_unemployment <- indicator_8_5_2_unemployment |> select(indicator_reference, geoAreaName, parentName, type, X, Y, ISO3, sex_code, sex_desc, disability_status_code, disability_status_desc, latest_value)

World <- select(World, ISO3="iso_a3", geometry="geometry")
```

# Relationship between nation's legal framework achievements in gender equality and woman's success in the economy.

## Purpose of This Presentation

## Research Questions

To what extent does a nation's legal framework on gender equality affect economic growth for women?

Specifically, what is the relationship between a [nation's legal framework achievements in gender equality]{.underline} and [woman's success in the economy]{.underline}?

Can [GDP]{.underline}, [Happy Planet Index Score]{.underline} and [Continent]{.underline} serve as predictors for a nation's legal framework achievements in gender equality & proportion of women in managerial positions?

## Importance of This Research

-   Economic empowerment:

The economic empowerment of women has broader implications for overall economic development.

-   Policy formulation:

Inform policymakers and lawmakers about the effectiveness and relevance of legal frameworks in fostering economic growth for women.

## Importance of This Research

-   Gender equality:

The impact of these legal frameworks is crucial in advancing gender equality efforts.

-   Societal impact:

Sheds light on the potential benefits and consequences of legal frameworks on economic growth, impacting woman's lives and opportunities.

## UN Sustainable Development Goals

Women participation in the economy is related to Goals 5 and 8.

## Selected Indicators

**Indicator 5.1.1**: Legal frameworks that promote enforce and monitor gender equality (percentage of achievement 0 - 100) \-- Area 3: employment and economic benefits

**Indicator 5.5.2:** Proportion of women in managerial positions

**Indicator 8.5.1:** Average hourly earnings of employees by sex, age, occupation and persons with disabilities

**Indicator 8.5.2:** Unemployment rate by sex, age and persons with disabilities

## Choropleth Map: **5.1.1**

```{r}
# Wong Jun HAO
cmap_511 <-
  World |>
  left_join(indicator_5_1_1_employment_economic_benefits, by = c("ISO3"))

cmap_511 <-
  mutate(cmap_511,
         percent = cut(
           latest_value,
           breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90,
                      max(latest_value, na.rm = TRUE)),
           labels = c(
             "0 to 10",
             "10 to 20",
             "20 to 30",
             "30 to 40",
             "40 to 50",
             "50 to 60",
             "60 to 70",
             "70 to 80",
             "80 to 90",
             "90 to 100"
           )
         ))


tm_poa_after_shape <-
  tm_polygons(col = "percent",
              palette = "Greens",
              title = "Percentage of \nachievement") +
  tm_layout(
    main.title =
      "Legal frameworks that promote, enforce and monitor gender equality
in the area of employment and economic benefits",
    legend.position = c("left", "top"),
    inner.margins = c(0.01, 0.2, 0.01, 0.01),
    bg.color = "lightblue",
    earth.boundary = TRUE,
    space.color = "white",
    frame = FALSE
  ) +
  tm_text("ISO3", size = "AREA") +
  tm_credits("Source: United Nations Statistics Division",
             position = c("left", "bottom"))

tm_poa <-
  tm_shape(cmap_511, projection = "ESRI:54012") +
  tm_poa_after_shape

tm_poa
```

## Choropleth Map: **5.5.2**

```{r}
# Wong Jun HAO
cmap_552 <-
  World |>
  left_join(indicator_5_5_2_managerial, by = c("ISO3"))

cmap_552 <-
  mutate(cmap_552,
         percent = cut(
           latest_value,
           breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90,
                      max(latest_value, na.rm = TRUE)),
           labels = c(
             "0 to 10",
             "10 to 20",
             "20 to 30",
             "30 to 40",
             "40 to 50",
             "50 to 60",
             "60 to 70",
             "70 to 80",
             "80 to 90",
             "90 to 100"
           )
         ))



tm_poa_after_shape <-
  tm_polygons(col = "percent",
              palette = "Greens",
              title = "Percentages") +
  tm_layout(
    main.title =
      "Proportion of women in managerial positions",
    legend.position = c("left", "top"),
    inner.margins = c(0.01, 0.2, 0.01, 0.01),
    bg.color = "lightblue",
    earth.boundary = TRUE,
    space.color = "white",
    frame = FALSE
  ) +
  tm_text("ISO3", size = "AREA") +
  tm_credits("Source: United Nations Statistics Division",
             position = c("left", "bottom"))

tm_poa <-
  tm_shape(cmap_552, projection = "ESRI:54012") +
  tm_poa_after_shape

tm_poa
```

## **5.1.1 vs 5.5.2 Anticipation**

We anticipate that the higher the nation's legal framework achievements in gender equality will result in a higher percentage of women holding managerial positions.

-   Because the chance of gender-based discrimination should be reduced as a result of the legal frameworks in place, this should result in better opportunities for women to hold managerial positions.

## **5.1.1 vs 5.5.2 Relation**

```{r}
# Wong Jun HAO
# Correlation Graph. See Sample-Project slide 11,12,15 *Please Judge if is approriate. Goal is to see if there is any significant statitical correlation

formatted_5_1_1 <-
  select(
    indicator_5_1_1_employment_economic_benefits,
    ISO3 = "ISO3",
    Country = "geoAreaName",
    "% Employment Legal Framework Achievement" = "latest_value"
  )

formatted_5_5_2 <-
  select(
    indicator_5_5_2_managerial,
    ISO3 = "ISO3",
    Country = "geoAreaName",
    "% Female in Management Position" = "latest_value"
  )

merged_data <- formatted_5_1_1 |>
  left_join(formatted_5_5_2,
            by = c('ISO3', 'Country'),
            relationship = "many-to-many") |>
  drop_na()

plot <- ggpairs(
  merged_data,
  mapping = aes(alpha = 0.7, fill = Country),
  title = "Employment Legal Frameworks and Female Managerial Rate",
  columns = c(
    "% Employment Legal Framework Achievement",
    "% Female in Management Position"
  ),
  diag = list(continuous = wrap(
    "barDiag", bins = 10, color = "black"
  )),
  lower = list(
    continuous = wrap(
      "points",
      position = position_jitter(height = 1,
                                 width = 0.5),
      fill = "black"
    )
  )
)

#ggplotly(plot)
plot
```

## **5.1.1 vs 5.5.2 Relation data re-expression if needed**

```{r}
# Wong Jun HAO
# Correlation Graph. See Sample-Project slide 11,12,15 *Please Judge if is approriate. Goal is to see if there is any significant statitical correlation
# Perform transformation
```

## Choropleth Map: **8.5.1**

```{r}
# JEANIE OH JUN NING

# getting exchange rate for USD 
exchange_rate <- exchange_rate_latest("USD")  

# retrieving only Females 
indicator_8_5_1_average_hourly <- filter(indicator_8_5_1_average_hourly, sex_code == "F")  

# get currency code and country code from country name 
indicator_8_5_1_average_hourly <- mutate(indicator_8_5_1_average_hourly,   
    currency_code = countrycode(
      ISO3,
      origin = 'iso3c',
      destination = 'iso4217c',
      warn = FALSE))  

# get value in USD 
indicator_8_5_1_average_hourly$exchange_usd <- exchange_rate$one_usd_is_equivalent_to[match(indicator_8_5_1_average_hourly$currency_code, exchange_rate$currency)] 

indicator_8_5_1_average_hourly$amount_usd <- indicator_8_5_1_average_hourly$latest_value / indicator_8_5_1_average_hourly$exchange_usd   

# max USD = 64.19665 
# min value = 0 
# max(indicator_8_5_1_average_hourly$amount_usd, na.rm = T) 
# min(indicator_8_5_1_average_hourly$amount_usd, na.rm = T)  

# graph from 1-65 
cmap_851 <-   
  World |> left_join(indicator_8_5_1_average_hourly, by = c("ISO3"))  

cmap_851 <- mutate(cmap_851, 
    usd_earning = cut(
      amount_usd,
      breaks = c(0,1,2,3,5,8,13,21,34,55,
          max(amount_usd, na.rm = TRUE)), 
      labels = c(
        "0 to 1",
        "1 to 2",
        "2 to 3",
        "3 to 5",
        "5 to 8", 
        "8 to 13",
        "13 to 21",
        "21 to 34",
        "34 to 55",
        "55 and above" 
        )
      ))   

tm_poa_after_shape <- 
  tm_polygons(col = "usd_earning",
      palette = "Greens",
      title = "Earnings in USD") + 
  tm_layout(
      main.title = "Average Hourly Earning by Women", 
      legend.position = c("left", "top"),
      inner.margins = c(0.01, 0.2, 0.01, 0.01), 
      bg.color = "lightblue", 
      earth.boundary = TRUE,
      space.color = "white",
      frame = FALSE   
    ) + 
  tm_text("ISO3", size = "AREA") +   
  tm_credits("Source: United Nations Statistics Division",
      position = c("left", "bottom"))  

tm_poa <- tm_shape(cmap_851, projection = "ESRI:54012") + 
  tm_poa_after_shape  

tm_poa
```

## Choropleth Map: **8.5.2**

```{r}
# JEANIE OH JUN NING

# retrieving only Females 
indicator_8_5_2_unemployment <- filter(indicator_8_5_2_unemployment, sex_code == "F") 

# nrow(indicator_8_5_2_unemployment)
# count <- sum(!is.na(indicator_8_5_2_unemployment$latest_value) & indicator_8_5_2_unemployment$latest_value >= 40 & indicator_8_5_2_unemployment$latest_value <= 50)
# count

# max percent =  50
# min value = 0.9
# max(indicator_8_5_2_unemployment$latest_value, na.rm = T) 
# min(indicator_8_5_2_unemployment$latest_value, na.rm = T) 

cmap_852 <-   
  World |> left_join(indicator_8_5_2_unemployment, by = c("ISO3"))  

cmap_852 <-
  mutate(cmap_852,
         percent = cut(
           latest_value,
           breaks = c(0, 5, 10, 15, 20, 30, 40,
                      max(latest_value, na.rm = TRUE)),
           labels = c(
             "0 to 5",
             "5 to 10",
             "10 to 15",
             "15 to 20",
             "20 to 30",
             "30 to 40",
             "40 to 50"
           )
         ))



tm_poa_after_shape <-
  tm_polygons(col = "percent",
              palette = "Greens",
              title = "Percentages") +
  tm_layout(
    main.title =
      "Unemployment Rate of Women",
    legend.position = c("left", "top"),
    inner.margins = c(0.01, 0.2, 0.01, 0.01),
    bg.color = "lightblue",
    earth.boundary = TRUE,
    space.color = "white",
    frame = FALSE
  ) +
  tm_text("ISO3", size = "AREA") +
  tm_credits("Source: United Nations Statistics Division",
             position = c("left", "bottom"))

tm_poa <-
  tm_shape(cmap_852, projection = "ESRI:54012") +
  tm_poa_after_shape

tm_poa
```

## **8.5.1 vs 8.5.2 Anticipation**

We anticipate that countries with lower unemployment rates for women should have higher average hourly earnings for women.

-   Because countries with lower unemployment rates have a better economic environment which should result in higher average income for their citizens

## **8.5.1 vs 8.5.2 Relation**

```{r}
# JEANIE OH JUN NING
# Correlation Graph. See Sample-Project slide 11,12,15 *Please Judge if is approriate. Goal is to see if there is any significant statitical correlation 

graph_usd_dollar <- select(
  indicator_8_5_1_average_hourly,
  amtusd = "amount_usd",
  geoAreaName = "geoAreaName",
  ISO3 = "ISO3"
  )

graph_unemployment <- select(
  indicator_8_5_2_unemployment,
  percent = "latest_value",
  geoAreaName = "geoAreaName",
  ISO3 = "ISO3"
  )


#joined_unemployment_amtusd <- left_join(graph_usd_dollar, graph_unemployment, by = c("ISO3", "geoAreaName")) %>% na.omit()

joined_unemployment_amtusd <- graph_usd_dollar |>
  left_join(graph_unemployment,
            by = c('ISO3', 'geoAreaName'),
            relationship = "many-to-many") |>
  drop_na()

min_max_scale <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}

joined_unemployment_amtusd <- joined_unemployment_amtusd %>%
  mutate(amtusd_scaled = min_max_scale(amtusd),
         percent_scaled = min_max_scale(percent))

# Create a scatterplot matrix using ggpairs
# ggpairs(joined_df, columns = 3:4)
g_pairs <- ggpairs(joined_unemployment_amtusd, columns = c("amtusd_scaled", "percent_scaled"), ggplot2::aes(label=geoAreaName))

# ggplotly(g_pairs)
g_pairs
```

## **8.5.1 vs 8.5.2 Relation data re-expression if needed**

```{r}
# JEANIE OH JUN NING
# Correlation Graph. See Sample-Project slide 11,12,15 *Please Judge if is approriate. Goal is to see if there is any significant statitical correlation 
```

## **Table of Women Economical Success**

```{r}

# Table of performances. See Sample-Project slide 16
```

## **5.1.1 vs 8.5.2 Anticipation** {data-transitions="slide-in"}

We anticipate that having a higher the nation's legal framework achievements in gender equality would result in lower unemployment rate for women.

-   Because by decreasing gender discrimination for women, more companies would be willing to employ women.

## **5.1.1 vs 8.5.2 Relation** {data-transitions="slide-in"}

<small>There doesn't seem to be any significant correlation between the percentage of legal employment and benefit frameworks for females, and the unemployment rate of females. However, this might be due to skewed distributions, hence we will re-express this data. </small>

```{r}
#| fig-width: 10
#| fig-height: 5
# CHIA YI XUAN
# Correlation Graph. See Sample-Project slide 11,12,15 *Please Judge if is approriate. Goal is to see if there is any significant statitical correlation 

# format 5.1.1 data into focused columns
formatted_5_1_1 <- indicator_5_1_1_employment_economic_benefits |> 
  drop_na(latest_value) |>
  select("Country" = geoAreaName, ISO3, "% Female Legal Coverage" = latest_value) |>
  distinct(ISO3, .keep_all = TRUE)

# format 8.5.2 data into focused columns
formatted_8_5_2 <- indicator_8_5_2_unemployment |>
  drop_na(latest_value) |>
  select("Country" = geoAreaName, ISO3, disability_status_desc, "sex" = sex_desc, "% Females Unemployed" = latest_value) |>
  filter(`sex` %in% c("Female"), disability_status_desc == "No breakdown by disability") |>
  select(Country, ISO3, sex, "% Females Unemployed") |>
  distinct(ISO3, .keep_all = TRUE)



# merge data using left join, and drop all NA rows
merged_data <- formatted_8_5_2 |>
  left_join(formatted_5_1_1, by = c("ISO3", "Country")) |>
  drop_na()


# initial 
plot <- ggpairs(merged_data,
        mapping = aes(alpha = 0.7, fill = Country),
        title = "Employment Legal Frameworks and Female Unemployment rate",
        columns = c("% Female Legal Coverage", 
            "% Females Unemployed"),
        diag = list(continuous = wrap("barDiag", bins = 10, color = "black")),
        lower = list(continuous = wrap("points", 
                                     position=position_jitter(
                                       height = 1, 
                                       width = 0.5),
                                     fill = "black"))
        ) 

#ggplotly(plot)
plot

```

## **5.1.1 vs 8.5.2 Relation Re-Expressed** {data-transitions="slide-in"}

<small>After Box Cox and logarithmic transformations, correlation coefficient seems to have improved positively. However, it still appears to be insignificant. </small>

```{r}
#| fig-width: 10
#| fig-height: 5

# Perform transformation
merged_data <- merged_data |>
  mutate("log_10(% Females Unemployed)" = log10(`% Females Unemployed`))

x <- merged_data$`% Female Legal Coverage`
b <- MASS::boxcox(x ~ 1, plotit = FALSE, )
lambda <- b$x[which.max(b$y)] # -0.02

new_x_exact <- (x ^ lambda - 1) / lambda
new_x <- log(x)
merged_data <- merged_data |>
  mutate("Box-Cox % Female Legal Coverage" = new_x)

# re-expressed plot
plot <- ggpairs(merged_data,
        mapping = aes(alpha = 0.7, fill = Country),
        title = "Employment Legal Frameworks and Female Unemployment rate",
        columns = c("Box-Cox % Female Legal Coverage", 
            "log_10(% Females Unemployed)"),
        diag = list(continuous = wrap("barDiag", bins = 8, color = "black")),
        lower = list(continuous = wrap("points", 
                                     position=position_jitter(
                                       height=1, 
                                       width=0.5),
                                     fill = "black"))
        ) 

# ggplotly(plot)
plot

```

## **5.5.2 vs 8.5.1 Anticipation**

We anticipate that having more women in managerial positions will increase the average hourly earning for female employees.

-   Because in general, employees in a managerial position would receive higher income and with more women holding managerial positions, the average hourly earning for female employees will increase.

## **5.5.2 vs 8.5.1 Relation**

There seems to be a negative correlation between the percentage of female hourly earnings and women in managerial positions. However, this might be due to skewed distributions of female hourly earnings, hence we will re-express this data using logarithmic transformations .

```{r}
# Correlation Graph. See Sample-Project slide 11,12,15 *Please Judge if is approriate. Goal is to see if there is any significant statitical correlation 

# Format 5.5.2 data into focused columns
formatted_5_5_2 <- indicator_5_5_2_managerial |>
  drop_na(latest_value) |>
  select("Country" = geoAreaName, ISO3, "% Women in Managerial Positions" = latest_value) |>
  distinct(ISO3, .keep_all = TRUE)

# Format 8.5.1 data into focused columns
formatted_8_5_1 <- indicator_8_5_1_average_hourly |>
  drop_na(latest_value) |>
  filter(sex_desc == "Female") |>
  select("Country" = geoAreaName, ISO3, "% Female Hourly Earnings" = latest_value) |>
  distinct(ISO3, .keep_all = TRUE)

# Merge data using left join, and drop all NA rows
merged_data <- formatted_5_5_2 |>
  left_join(formatted_8_5_1, by = c("ISO3", "Country")) |>
  drop_na()

# Create 4 grid plots using ggpairs()
grid_plots <- ggpairs(merged_data,
                      mapping = aes(alpha = 0.7, fill = Country),
                      title = "Proportion of Women in Managerial Positions vs Average Hourly Earnings (Female Employees)",
                      columns = c("% Women in Managerial Positions", "% Female Hourly Earnings"),
                      diag = list(continuous = wrap("barDiag", bins = 10, color = "black")),
                      lower = list(continuous = wrap("points",
                                                    position = position_jitter(
                                                      height = 1,
                                                      width = 0.5),
                                                    fill = "black"))
)

# Print 4 grid plots
grid_plots

```

## **5.1.1 vs 8.5.2 Relation Re-Expressed** {data-transitions="slide-in"}

After logarithmic transformations for female hourly earnings, correlation coefficient seems to have decreased. However, it still appears to be negatively correlated .

```{r}
#| fig-width: 10
#| fig-height: 5

# Format 5.5.2 data into focused columns
formatted_5_5_2 <- indicator_5_5_2_managerial |>
  drop_na(latest_value) |>
  select("Country" = geoAreaName, ISO3, "% Women in Managerial Positions" = latest_value) |>
  distinct(ISO3, .keep_all = TRUE)

# Format 8.5.1 data into focused columns
formatted_8_5_1 <- indicator_8_5_1_average_hourly |>
  drop_na(latest_value) |>
  filter(sex_desc == "Female") |>
  select("Country" = geoAreaName, ISO3, "% Female Hourly Earnings" = latest_value) |>
  distinct(ISO3, .keep_all = TRUE)

# Merge data using left join, and drop all NA rows
merged_data <- formatted_5_5_2 |>
  left_join(formatted_8_5_1, by = c("ISO3", "Country")) |>
  drop_na()

# Perform log transformation for "% Female Hourly Earnings"
merged_data <- merged_data |>
  mutate("log(% Female Hourly Earnings)" = log(`% Female Hourly Earnings`))

# Create 4 grid plots using ggpairs()
grid_plots <- ggpairs(merged_data,
                      mapping = aes(alpha = 0.7, fill = Country),
                      title = "Proportion of Women in Managerial Positions vs Average Hourly Earnings (Female Employees)",
                      columns = c("% Women in Managerial Positions", "log(% Female Hourly Earnings)"),
                      diag = list(continuous = wrap("barDiag", bins = 10, color = "black")),
                      lower = list(continuous = wrap("points",
                                                    position = position_jitter(
                                                      height = 1,
                                                      width = 0.5),
                                                    fill = "black"))
)

# Print 4 grid plots
grid_plots
```

## Four-variable pair plot

```{r}
#| fig-width: 10
#| fig-height: 5

# Yi Xuan and Jin Ming

# format 5.1.1 data into focused columns
formatted_5_1_1 <- indicator_5_1_1_employment_economic_benefits |> 
  drop_na(latest_value) |>
  select("Country" = geoAreaName, ISO3, "% Female Legal Coverage" = latest_value) |>
  distinct(ISO3, .keep_all = TRUE)

# format 8.5.2 data into focused columns
formatted_8_5_2 <- indicator_8_5_2_unemployment |>
  drop_na(latest_value) |>
  select("Country" = geoAreaName, ISO3, disability_status_desc, "sex" = sex_desc, "% Females Unemployed" = latest_value) |>
  filter(`sex` %in% c("Female"), disability_status_desc == "No breakdown by disability") |>
  select(Country, ISO3, sex, "% Females Unemployed") |>
  distinct(ISO3, .keep_all = TRUE)

# Format 5.5.2 data into focused columns
formatted_5_5_2 <- indicator_5_5_2_managerial |>
  drop_na(latest_value) |>
  select("Country" = geoAreaName, ISO3, "% Women in Managerial Positions" = latest_value) |>
  distinct(ISO3, .keep_all = TRUE)

# Format 8.5.1 data into focused columns
formatted_8_5_1 <- indicator_8_5_1_average_hourly |>
  drop_na(latest_value) |>
  filter(sex_desc == "Female") |>
  select("Country" = geoAreaName, ISO3, "% Female Hourly Earnings" = latest_value) |>
  distinct(ISO3, .keep_all = TRUE)


# merge data using left join, and drop all NA rows
merged_data <- formatted_8_5_2 |>
  left_join(formatted_5_1_1, by = c("ISO3", "Country")) |>
  left_join(formatted_5_5_2, by = c("ISO3", "Country")) |>
  left_join(formatted_8_5_1, by = c("ISO3", "Country"))

# Drop rows with NA values
merged_data <- drop_na(merged_data)

# Create grid plots using ggpairs()
grid_plots <- ggpairs(merged_data,
                      mapping = aes(alpha = 0.7, fill = Country),
                      title = "Relationship between Indicators",
                      columns = c("% Female Legal Coverage", "% Females Unemployed", "% Women in Managerial Positions", "% Female Hourly Earnings"),
                      diag = list(continuous = wrap("barDiag", bins = 10, color = "black")),
                      lower = list(continuous = wrap("points",
                                                    position = position_jitter(height = 1, width = 0.5),
                                                    fill = "black"))
)

# Print the grid plots
grid_plots

```

## K-Means Clustering

```{r}
# VARADHARAJAN JAYAPRIYA
# Combine the datasets
combined_data <- bind_rows(
  indicator_5_1_1_employment_economic_benefits,
  indicator_5_5_2_managerial,
  indicator_8_5_1_average_hourly,
  indicator_8_5_2_unemployment
)

# Select columns for clustering (assuming "latest_value" is the numeric variable)
columns_for_clustering <- c("latest_value")

# Normalize the data using Min-Max scaling
normalized_data <- combined_data %>%
  mutate_at(vars(columns_for_clustering), scales::rescale)

# Elbow plot to determine the optimal k value
elbow_data <- data.frame(k = 1:10, total_withinss = numeric(10))

for (k in 1:10) {
  kmeans_result <- kmeans(normalized_data[columns_for_clustering], centers = k)
  elbow_data[k, "total_withinss"] <- kmeans_result$tot.withinss
}

# Create the elbow plot
ggplot(elbow_data, aes(x = k, y = total_withinss)) +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  labs(x = "Number of Clusters (k)", y = "Total Within Sum of Squares") +
  theme_minimal()

```

## Pairs Plot Highlighting Clusters

```{r}
# See project-sample slide 20

# Set number of clusters (k)
k <- 3

# Build the K-means model
set.seed(123)
kmeans_result <- kmeans(normalized_data[columns_for_clustering], centers = k, nstart = 20)

# Add cluster assignments to the original data
normalized_data$cluster_id <- factor(kmeans_result$cluster)

# Define cluster labels
cluster_labels <- paste("Cluster", 1:k)

# Convert the centroid matrix to a data frame
centroids <- as.data.frame(kmeans_result$centers)

# Plot the data with cluster assignments and circles
ggplot(normalized_data, aes(x = latest_value, y = X, color = cluster_id)) +
  geom_point(alpha = 0.5, size = 3) +
  scale_color_manual(values = c("red", "blue", "green"), labels = cluster_labels) +
  xlab("Normalized Indicator Value") +
  ylab("Another Variable (X)") +
  ggtitle("Clustering Analysis") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

```

## Decision Tree

```{r}
# Checking (To be removed) 

normalized_data <- arrange(normalized_data, geoAreaName)
normalized_data
```

```{r}
#| echo: false

# TSUI SAU CHI (JAMES)

# Load Country Level Data 

# Step1: Import Data 
happy_index <- read_excel("data/happy-planet-index-2006-2020-public-data-set.xlsx", sheet = 2, skip = 7)
happy_index <- select(
  happy_index, ISO3 = "ISO", GDP = "GDP per capita ($)", HPI
  )

countries_sf <- st_read("data/WB_countries_Admin0.geojson")
countries_sf  <- select(
  countries_sf, Continent = "CONTINENT", ISO3 = "ISO_A3"
  )
countries_sf <- st_drop_geometry(countries_sf)
countries_sf <- as_tibble(countries_sf)

```

```{r}

# Step1: Import Data

merged_data <- select(
  normalized_data, ISO3 = "ISO3", cluster_id = "cluster_id",
) |> drop_na()

# Merge data using left join, and drop all NA rows
merged_data <-  merged_data |>
  left_join(countries_sf, by = c("ISO3")) |>
  drop_na()

merged_data <-  merged_data |>
  left_join(happy_index, by = c("ISO3")) |>
  drop_na()

merged_data <- distinct(merged_data)

merged_data$Continent <- as.factor(merged_data$Continent)
merged_data$GDP <- as.numeric(merged_data$GDP)
merged_data <- merged_data %>% select(-ISO3)

# Shuffle Data 
shuffle_index <- sample(1:nrow(merged_data))
merged_data <- merged_data[shuffle_index, ]

# Step 2: Create training / Test Set
set.seed(123)
data_split <- initial_split(merged_data, prop = 0.8)
train_data <- training(data_split)
test_data <- testing(data_split)

# Step 3: Build the model
tree <- rpart(cluster_id ~., data = train_data, method="class", minsplit=1, minbucket=1)
rpart.plot(tree, box.palette="GnRd")
str(train_data)

```


## Evaluation of Decision Tree

\# See project-sample slide 22

## Summary of Quantitative Results

\# See project-sample slide 23

\# Last item, require above to be done

## Policy Implications

\# See project-sample slide 24

\# Last item, require above to be done

```{r}
#| label: lint

lint("csc3007-black2.qmd")
```
